<html>
 <head>
   <script src="mustache.js"></script>
   <script src="FileSaver.min.js"></script>
  
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <link href="css/bootstrap.min.css" rel="stylesheet" media="screen" />
   <link rel="stylesheet" href="style.css" />
 </head>
<body>
  <div class="container">
    <ul class="nav nav-tabs">
      <li class="active"><a href="#" id="select_section_0">Introduction</a></li>
      <li><a href="#" id="select_section_1">Section #1</a></li>
      <li><a href="#" id="select_section_2">Section #2</a></li>
      <li><a href="#" id="select_section_3">Section #3</a></li>
      <li><a href="#" id="select_section_4">Section #4</a></li>
      <li><a href="#" id="select_section_5">Insta-setup</a></li>
      <li><a href="#" id="select_section_90">Generate</a></li>
      <li><a href="#" id="select_section_99">About</a></li>
    </ul>
   <div id='core'>
     <!-- Introduction -->
     <div id='section0' class='section'>
         <div class='row'>
            <form style="display:none" id="file-load-form">
                <input type="file" id="file-load" name="files[]" multiple class="form-control" style="display:none" />
            </form>
            <button type="button" id='loadjson_button' class="btn btn-default col-md-offset-6 col-md-3">Load JSON</button>
            <button type="button" id='savejson_button' class="btn btn-default col-md-3">Save JSON</button>
         </div>
         <div class='row'>
             <div class="form-group col-md-12">
                <label for="input_title">Title</label>
                <input type="text" class="form-control" id="input_title" placeholder="Playset title">
             </div>
         </div>
     </div>
     
   
     <!-- Sections 1 to 4 will be automatically generated by Mustache -->
     
     <!-- Generation by Mustache of the playset with the help of a template -->
     <div id='section90' class='section'>
        <div class='row'><p class='col-md-12'>Mustache template to use for the generation</p></div>
        <div class='row'><div class='col-md-10 col-md-offset-1'><textarea id='mustache_template' style='width:100%' rows='15' placeholder='Mustache template' required></textarea></div></div>
        <div class='row'><button type="button" id='generate_button' class="btn btn-primary col-md-offset-8 col-md-4">Generate !</button></div>
     </div>
   </div>
 
 </div>
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
 </body>
 <script>


/* Rendering functions */
function render_sections()
{
  var view = {
    sections: []
  };
  for(var iSection=1; iSection<=4; iSection++) {
    var section = {
      categories: [],
      sectionIdx: iSection
    };
    for(var iCategory=1; iCategory<=6; iCategory++)
    {
      var category = {
        details: [],
        categoryIdx: iCategory
      };
      for(var iDetail=1; iDetail<=6; iDetail++)
      {
        category.details.push(iDetail);
      }
      section.categories.push(category);
    }
    
    view.sections.push(section);
  }
  
  // Render the four "dice" sections, all the same
  return Mustache.render("{{#sections}}<div class='section' id='section{{sectionIdx}}'>" +
                             "<div class='sectionTitle row'>" +
                                 "<div class='col-md-12 form-group'>" +
                                    "<label for='sec{{sectionIdx}}'>Section designation</label>" +
                                    "<input id='sec{{sectionIdx}}' type='text' class='form-control' />" +
                                 "</div>" +
                             "</div>" +
                             "{{#categories}}<div class='category'>" +
                                 "<div class='categoryTitle row'>" + 
                                     "<div class='dice-category dice{{categoryIdx}} col-md-offset-2 col-md-6'>" +
                                         "<input id='sec{{sectionIdx}}_cat{{categoryIdx}}' type='text' class='form-control' />" +
                                     "</div>" +
                                     "<div class='col-md-2'><a class='btn btn-default category_showhide' href='#'>" + 
                                         "<span class='glyphicon glyphicon-chevron-up' aria-hidden='true'></span>Hide" +
                                     "</a></div>" +
                                 "</div>" +
                                 "{{#details}}<div class='categoryDetail row'>" +
                                     "<div class='col-md-5 col-md-offset-3 dice-detail dice{{.}}'>" +
                                         "<input id='sec{{sectionIdx}}_cat{{categoryIdx}}_detail{{.}}' type='text' class='form-control' />" +
                                     "</div>" +
                                 "</div>{{/details}}" +
                             "</div>{{/categories}}" +
                         "</div>{{/sections}}"
                         , view);
}

function click_section(sectionIdx)
{
  var lsIdx = [0, 1, 2, 3, 4, 5, 90, 99];
  for(var idx=0; idx<=lsIdx.length; idx++)
  {
    var sectionName = '#section' + lsIdx[idx];
    var sectionTab = '#select_section_' + lsIdx[idx];
    if (lsIdx[idx] == sectionIdx)
    {
      // Showing the section
      $(sectionName).show();
      $(sectionTab).parent().addClass('active');
    }
    else 
    {
      // Hiding the section
      $(sectionName).hide();
      $(sectionTab).parent().removeClass('active');
    }
  }
}

function get_generated_json()
{
  var jsonData = { };
  
  // Tables of elements
  jsonData.sections = [];
  // Each section
  for(var iSection = 1; iSection <= 4; iSection++) {
      var jsonSection = { libelle: $('#sec'+iSection).val() };
      jsonSection.categories = [];
      // Each category
      for (var iCategory = 1; iCategory <= 6; iCategory++) {
          var jsonCategory = { libelle: $('#sec' + iSection + '_cat' + iCategory).val() };
          jsonCategory.details = [];
          // Each detail
          for (var iDetail = 1; iDetail <= 6; iDetail++) {
              jsonCategory.details[iDetail - 1] = { libelle: $('#sec' + iSection + '_cat' + iCategory + '_detail' + iDetail).val() };              
          }
          jsonSection.categories[iCategory - 1] = jsonCategory;
      }
      jsonData.sections[iSection-1] = jsonSection;
  }
  
  // All elements with a single property
  
  return jsonData;
}

function generate_mustache()
{
  // The mustache template
  var mustacheTemplate = $('#mustache_template').val();
  var jsonData = get_generated_json();

  var blob = new Blob([Mustache.render(mustacheTemplate, jsonData)], {type: "text/plain;charset=utf-8"});
  saveAs(blob, "generated_template");
}

function save_json()
{
  var blob = new Blob([JSON.stringify(get_generated_json())], {type: "text/plain;charset=utf-8"});
  saveAs(blob, "fiasco_template.json");
}

function load_files(evt) {
    
    var files = evt.target.files;

    for (var i = 0, f; f = files[i]; i++) {
        var reader = new FileReader();

        reader.onload = function (reader) {
            var data = JSON.parse(this.result);
            load_from_json(data);
        };

        reader.readAsText(f);
    }

    // Reset file input
    $("#file-load-form")[0].reset();
}

function load_from_json(jsonData)
{
    for(var iSection = 1; iSection <= 4; iSection++) {
      $('#sec'+iSection).val(jsonData.sections[iSection-1].libelle);
      // Each category
      for (var iCategory = 1; iCategory <= 6; iCategory++) {
          $('#sec' + iSection + '_cat' + iCategory).val(jsonData.sections[iSection-1].categories[iCategory-1].libelle);
          // Each detail
          for (var iDetail = 1; iDetail <= 6; iDetail++) {
              $('#sec' + iSection + '_cat' + iCategory + '_detail' + iDetail).val(
                  jsonData.sections[iSection-1].categories[iCategory-1].details[iDetail-1].libelle);
          }
      }
  }
}

$(function() {
  $("#core").append(render_sections());
  
  // Click events on the sections
  var lsIdx = [0, 1, 2, 3, 4, 5, 90, 99];
  for(var idx=0; idx<=lsIdx.length; idx++) {    
        var selector = "#select_section_" + lsIdx[idx];
        $(selector).on('click', {id: lsIdx[idx]}, function (e) {
            click_section(e.data.id);
        });
    }
  click_section(0);
  
  // Click-events on the 'Display/Hide' buttons inside the Dice sections
  $('.category_showhide').click(function() {
    var isMasquer = $(this).children('span').hasClass('glyphicon-chevron-up');
    if (isMasquer) {
        $(this).parent().parent().siblings('.categoryDetail').hide();
        $(this).html("<span class='glyphicon glyphicon-chevron-down' aria-hidden='true'></span>Display");  
    } else {
        $(this).parent().parent().siblings('.categoryDetail').show();
        $(this).html("<span class='glyphicon glyphicon-chevron-up' aria-hidden='true'></span>Hide");  
    }    
  });
  
  // Click on the buttons
  $('#generate_button').click(function() { generate_mustache(); });
  $("#loadjson_button").click(function () { $("#file-load").click(); });
  $("#file-load").change(load_files);  
  $('#savejson_button').click(function() { save_json(); });
  
});
  </script>
</html>

