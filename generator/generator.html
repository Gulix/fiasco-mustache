<html>
 <head>
   <script src="js/mustache.js"></script>
   <script src="js/FileSaver.min.js"></script>

   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <link href="css/bootstrap.min.css" rel="stylesheet" media="screen" />
   <link rel="stylesheet" href="css/style.css" />
 </head>
<body>
  <div class="container">
    <h1>Fiasco-Mustache</h1>
    <h2>A playset-editor for Fiasco, with <s>a</s> Mustache ...</h2>
    <ul class="nav nav-tabs">
      <li class="active"><a href="#" id="select_section_0">Introduction</a></li>
      <li><a href="#" id="select_section_1">Section #1</a></li>
      <li><a href="#" id="select_section_2">Section #2</a></li>
      <li><a href="#" id="select_section_3">Section #3</a></li>
      <li><a href="#" id="select_section_4">Section #4</a></li>
      <li><a href="#" id="select_section_5">Insta-setup</a></li>
      <li><a href="#" id="select_section_90">Generate</a></li>
      <li><a href="#" id="select_section_99">About</a></li>
    </ul>
   <div id='core'>

   </div>

 </div>
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/pdfmake.min.js"></script>
    <script src="js/vfs_fonts.js"></script>
    <script src="scripts/rendering.js"></script>
    <script src="scripts/json.js"></script>
    <script src="scripts/pdf.js"></script>
    <script src="scripts/loadsave.js"></script>
 </body>
 <script>

function generate_mustache()
{
  // The mustache template
  var mustacheTemplate = $('#mustache_template').val();
  var jsonData = get_generated_json();

  var blob = new Blob([Mustache.render(mustacheTemplate, jsonData)], {type: "text/plain;charset=utf-8"});
  saveAs(blob, "generated_template_" + $('#input_title').val());
}

function init_uicontrols()
{
  // Click events on the sections
  var lsIdx = [0, 1, 2, 3, 4, 5, 90, 99];
  for(var idx=0; idx<=lsIdx.length; idx++) {
        var selector = "#select_section_" + lsIdx[idx];
        $(selector).on('click', {id: lsIdx[idx]}, function (e) {
            showhide_section(e.data.id);
        });
    }
  showhide_section(0);

  // Click-events on the 'Display/Hide' buttons inside the Dice sections
  $('.category_showhide').click(function() {
    var isMasquer = $(this).children('span').hasClass('glyphicon-chevron-up');
    if (isMasquer) {
        $(this).parent().parent().siblings('.categoryDetail').hide();
        $(this).html("<span class='glyphicon glyphicon-chevron-down' aria-hidden='true'></span>Display");
    } else {
        $(this).parent().parent().siblings('.categoryDetail').show();
        $(this).html("<span class='glyphicon glyphicon-chevron-up' aria-hidden='true'></span>Hide");
    }
  });

  // Click on the buttons
  $('#generate_button').click(function() { generate_mustache(); });
  $('#to-pdf-button').click(function() { generate_pdf(); });
  $("#loadjson_button").click(function () { $("#file-load").click(); });
  $("#file-load").change(load_files);
  $('#savejson_button').click(function() { save_json(); });

  // Fill the Section selectors with the right options
  $('.section-selection').each(function() {
    for(var idx = 1; idx <= 4; idx++)
    {
        var selectedValue = '';
        if ($(this).attr('id') == ('insta-setup-section-choice' + idx))
            selectedValue = ' selected';
        $(this).append("<option value='cat" + idx + "' class='section-option" + idx + "' " + selectedValue + " />");
    }
  });
  // Fill the Details selectors with the right options
  fill_details_options();
  update_section_labels();
  update_details_options();

  // Focus out of the sections name input
  for(var iSection=1; iSection <= 4; iSection++) {
      $('#sec' + iSection).focusout(function() { update_section_labels(); });
      for (var iCategory=1; iCategory <= 6; iCategory++) {
        for (var iDetail=1; iDetail <= 6; iDetail++) {
            $('#sec' + iSection + '_cat' + iCategory + '_det' + iDetail).focusout(function() { update_details_options(); });
        }
      }
  }
}

$(function() {

   $.ajax({
      url: 'html_template.mst',
      success: function(template) {
        $("#core").html(render_sections(template));
        init_uicontrols();
      },
      dataType: 'text'
   });



});
  </script>
</html>
